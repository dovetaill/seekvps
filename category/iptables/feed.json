{
    "version": "https://jsonfeed.org/version/1",
    "title": "VPS探索者 • All posts by \"iptables\" category",
    "description": "",
    "home_page_url": "http://www.seekvps.com",
    "items": [
        {
            "id": "http://www.seekvps.com/2024/03/06/iptables%E9%98%B2%E7%81%AB%E5%A2%99%E5%AF%B9docker%E7%AB%AF%E5%8F%A3%E4%B8%8D%E8%B5%B7%E4%BD%9C%E7%94%A8/",
            "url": "http://www.seekvps.com/2024/03/06/iptables%E9%98%B2%E7%81%AB%E5%A2%99%E5%AF%B9docker%E7%AB%AF%E5%8F%A3%E4%B8%8D%E8%B5%B7%E4%BD%9C%E7%94%A8/",
            "title": "iptables防火墙对docker端口不起作用",
            "date_published": "2024-03-06T01:07:14.000Z",
            "content_html": "<p>一般情况下宿主机如果想要指定某个IP某个端口可以用iptables进行操作</p>\n<pre class=\"line-numbers language-jsx\" data-language=\"jsx\"><code class=\"language-jsx\">iptables <span class=\"token operator\">-</span><span class=\"token constant\">I</span> <span class=\"token constant\">INPUT</span> <span class=\"token operator\">-</span>p tcp <span class=\"token operator\">--</span>dport <span class=\"token number\">80</span> <span class=\"token operator\">-</span>j <span class=\"token constant\">DROP</span>\niptables <span class=\"token operator\">-</span><span class=\"token constant\">I</span> <span class=\"token constant\">INPUT</span> <span class=\"token operator\">-</span>p tcp <span class=\"token operator\">-</span>s <span class=\"token number\">127.0</span><span class=\"token number\">.0</span><span class=\"token number\">.1</span> <span class=\"token operator\">--</span>dport <span class=\"token number\">80</span> <span class=\"token operator\">-</span>j <span class=\"token constant\">ACCEPT</span>\niptables <span class=\"token operator\">-</span><span class=\"token constant\">I</span> <span class=\"token constant\">INPUT</span> <span class=\"token operator\">-</span>p tcp <span class=\"token operator\">-</span>s <span class=\"token number\">172.172</span><span class=\"token number\">.172</span><span class=\"token number\">.172</span> <span class=\"token operator\">--</span>dport <span class=\"token number\">80</span> <span class=\"token operator\">-</span>j <span class=\"token constant\">ACCEPT</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p>但是对于对外暴漏出的docker的80端口并不会生效，这样我们排查一下</p>\n<p>查看iptables列表</p>\n<pre class=\"line-numbers language-jsx\" data-language=\"jsx\"><code class=\"language-jsx\">iptables <span class=\"token operator\">-</span>nL<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>有个DOCKER-USER链路，这个是官方建议操作的链路。其中链路中有一条规则</p>\n<pre class=\"line-numbers language-jsx\" data-language=\"jsx\"><code class=\"language-jsx\"><span class=\"token constant\">RETURN</span>     all  <span class=\"token operator\">--</span>  <span class=\"token number\">0.0</span><span class=\"token number\">.0</span><span class=\"token number\">.0</span><span class=\"token operator\">/</span><span class=\"token number\">0</span>            <span class=\"token number\">0.0</span><span class=\"token number\">.0</span><span class=\"token number\">.0</span><span class=\"token operator\">/</span><span class=\"token number\">0</span> <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>删除这个规则，并添加规则</p>\n",
            "tags": [
                "iptables"
            ]
        },
        {
            "id": "http://www.seekvps.com/2023/10/12/iptables%E8%87%AA%E5%8A%A8%E5%B1%8F%E8%94%BD%E8%AE%BF%E9%97%AE%E7%BD%91%E7%AB%99%E9%A2%91%E7%B9%81%E7%9A%84IP/",
            "url": "http://www.seekvps.com/2023/10/12/iptables%E8%87%AA%E5%8A%A8%E5%B1%8F%E8%94%BD%E8%AE%BF%E9%97%AE%E7%BD%91%E7%AB%99%E9%A2%91%E7%B9%81%E7%9A%84IP/",
            "title": "iptables自动屏蔽访问网站频繁的IP",
            "date_published": "2023-10-12T02:30:44.000Z",
            "content_html": "<h1 id=\"iptables自动屏蔽访问网站频繁的IP\"><a href=\"#iptables自动屏蔽访问网站频繁的IP\" class=\"headerlink\" title=\"iptables自动屏蔽访问网站频繁的IP\"></a>iptables自动屏蔽访问网站频繁的IP</h1><pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">\n场景：恶意访问<span class=\"token punctuation\">,</span>安全防范\n\n<span class=\"token number\">1</span>）屏蔽每分钟访问超过<span class=\"token number\">200</span>的<span class=\"token constant\">IP</span>\n\n方法<span class=\"token number\">1</span>：根据访问日志（<span class=\"token class-name\">Nginx</span>为例）\n\n#<span class=\"token operator\">!</span><span class=\"token operator\">/</span>bin<span class=\"token operator\">/</span>bash\n<span class=\"token constant\">DATE</span><span class=\"token operator\">=</span>$<span class=\"token punctuation\">(</span>date <span class=\"token operator\">+</span><span class=\"token operator\">%</span>d<span class=\"token operator\">/</span><span class=\"token operator\">%</span>b<span class=\"token operator\">/</span><span class=\"token operator\">%</span><span class=\"token class-name\">Y</span><span class=\"token operator\">:</span><span class=\"token operator\">%</span><span class=\"token class-name\">H</span><span class=\"token operator\">:</span><span class=\"token operator\">%</span><span class=\"token class-name\">M</span><span class=\"token punctuation\">)</span>\n<span class=\"token constant\">ABNORMAL_IP</span><span class=\"token operator\">=</span>$<span class=\"token punctuation\">(</span>tail <span class=\"token operator\">-</span>n5000 access<span class=\"token punctuation\">.</span>log <span class=\"token operator\">|</span>grep $<span class=\"token constant\">DATE</span> <span class=\"token operator\">|</span>awk '<span class=\"token punctuation\">&#123;</span>a<span class=\"token punctuation\">[</span>$<span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token operator\">++</span><span class=\"token punctuation\">&#125;</span><span class=\"token constant\">END</span><span class=\"token punctuation\">&#123;</span><span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span>i in a<span class=\"token punctuation\">)</span><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token operator\">></span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span>print i<span class=\"token punctuation\">&#125;</span>'<span class=\"token punctuation\">)</span>\n#先tail防止文件过大，读取慢，数字可调整每分钟最大的访问量。awk不能直接过滤日志，因为包含特殊字符。\n<span class=\"token keyword\">for</span> <span class=\"token constant\">IP</span> in $<span class=\"token constant\">ABNORMAL_IP</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">do</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> $<span class=\"token punctuation\">(</span>iptables <span class=\"token operator\">-</span>vnL <span class=\"token operator\">|</span>grep <span class=\"token operator\">-</span>c <span class=\"token string\">\"$IP\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span>eq <span class=\"token number\">0</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> then\n        iptables <span class=\"token operator\">-</span><span class=\"token class-name\">I</span> <span class=\"token constant\">INPUT</span> <span class=\"token operator\">-</span>s $<span class=\"token constant\">IP</span> <span class=\"token operator\">-</span>j <span class=\"token constant\">DROP</span>\n    fi\ndone\n方法<span class=\"token number\">2</span>：通过<span class=\"token constant\">TCP</span>建立的连接\n\n#<span class=\"token operator\">!</span><span class=\"token operator\">/</span>bin<span class=\"token operator\">/</span>bash\n<span class=\"token constant\">ABNORMAL_IP</span><span class=\"token operator\">=</span>$<span class=\"token punctuation\">(</span>netstat <span class=\"token operator\">-</span>an <span class=\"token operator\">|</span>awk '$<span class=\"token number\">4</span><span class=\"token operator\">~</span><span class=\"token operator\">/</span><span class=\"token operator\">:</span><span class=\"token number\">80</span>$<span class=\"token operator\">/</span> <span class=\"token operator\">&amp;&amp;</span> $<span class=\"token number\">6</span><span class=\"token operator\">~</span><span class=\"token operator\">/</span><span class=\"token constant\">ESTABLISHED</span><span class=\"token operator\">/</span><span class=\"token punctuation\">&#123;</span><span class=\"token function\">gsub</span><span class=\"token punctuation\">(</span><span class=\"token operator\">/</span><span class=\"token operator\">:</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token operator\">-</span><span class=\"token number\">9</span><span class=\"token punctuation\">]</span><span class=\"token operator\">+</span><span class=\"token operator\">/</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span>$<span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">&#123;</span>a<span class=\"token punctuation\">[</span>$<span class=\"token number\">5</span><span class=\"token punctuation\">]</span><span class=\"token operator\">++</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span><span class=\"token constant\">END</span><span class=\"token punctuation\">&#123;</span><span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span>i in a<span class=\"token punctuation\">)</span><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token operator\">></span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span>print i<span class=\"token punctuation\">&#125;</span>'<span class=\"token punctuation\">)</span>\n#gsub是将第五列（客户端<span class=\"token constant\">IP</span>）的冒号和端口去掉\n<span class=\"token keyword\">for</span> <span class=\"token constant\">IP</span> in $<span class=\"token constant\">ABNORMAL_IP</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">do</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> $<span class=\"token punctuation\">(</span>iptables <span class=\"token operator\">-</span>vnL <span class=\"token operator\">|</span>grep <span class=\"token operator\">-</span>c <span class=\"token string\">\"$IP\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span>eq <span class=\"token number\">0</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> then\n        iptables <span class=\"token operator\">-</span><span class=\"token class-name\">I</span> <span class=\"token constant\">INPUT</span> <span class=\"token operator\">-</span>s $<span class=\"token constant\">IP</span> <span class=\"token operator\">-</span>j <span class=\"token constant\">DROP</span>\n    fi\ndone\n\n<span class=\"token number\">2</span>）屏蔽每分钟<span class=\"token constant\">SSH</span>尝试登录超过<span class=\"token number\">10</span>次的<span class=\"token constant\">IP</span>\n\n方法<span class=\"token number\">1</span>：通过lastb获取登录状态<span class=\"token operator\">:</span>\n\n#<span class=\"token operator\">!</span><span class=\"token operator\">/</span>bin<span class=\"token operator\">/</span>bash\n<span class=\"token constant\">DATE</span><span class=\"token operator\">=</span>$<span class=\"token punctuation\">(</span>date <span class=\"token operator\">+</span><span class=\"token string\">\"%a %b %e %H:%M\"</span><span class=\"token punctuation\">)</span> #星期月天时分  <span class=\"token operator\">%</span>e单数字时显示<span class=\"token number\">7</span>，而<span class=\"token operator\">%</span>d显示<span class=\"token number\">07</span>\n<span class=\"token constant\">ABNORMAL_IP</span><span class=\"token operator\">=</span>$<span class=\"token punctuation\">(</span>lastb <span class=\"token operator\">|</span>grep <span class=\"token string\">\"$DATE\"</span> <span class=\"token operator\">|</span>awk '<span class=\"token punctuation\">&#123;</span>a<span class=\"token punctuation\">[</span>$<span class=\"token number\">3</span><span class=\"token punctuation\">]</span><span class=\"token operator\">++</span><span class=\"token punctuation\">&#125;</span><span class=\"token constant\">END</span><span class=\"token punctuation\">&#123;</span><span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span>i in a<span class=\"token punctuation\">)</span><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token operator\">></span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span>print i<span class=\"token punctuation\">&#125;</span>'<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">for</span> <span class=\"token constant\">IP</span> in $<span class=\"token constant\">ABNORMAL_IP</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">do</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> $<span class=\"token punctuation\">(</span>iptables <span class=\"token operator\">-</span>vnL <span class=\"token operator\">|</span>grep <span class=\"token operator\">-</span>c <span class=\"token string\">\"$IP\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span>eq <span class=\"token number\">0</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> then\n        iptables <span class=\"token operator\">-</span><span class=\"token class-name\">I</span> <span class=\"token constant\">INPUT</span> <span class=\"token operator\">-</span>s $<span class=\"token constant\">IP</span> <span class=\"token operator\">-</span>j <span class=\"token constant\">DROP</span>\n    fi\ndone\n方法<span class=\"token number\">2</span>：通过日志获取登录状态\n\n#<span class=\"token operator\">!</span><span class=\"token operator\">/</span>bin<span class=\"token operator\">/</span>bash\n<span class=\"token constant\">DATE</span><span class=\"token operator\">=</span>$<span class=\"token punctuation\">(</span>date <span class=\"token operator\">+</span><span class=\"token string\">\"%b %d %H\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token constant\">ABNORMAL_IP</span><span class=\"token operator\">=</span><span class=\"token string\">\"$(tail -n10000 /var/log/auth.log |grep \"</span>$<span class=\"token constant\">DATE</span><span class=\"token string\">\" |awk '/Failed/&#123;a[$(NF-3)]++&#125;END&#123;for(i in a)if(a[i]>5)print i&#125;')\"</span>\n<span class=\"token keyword\">for</span> <span class=\"token constant\">IP</span> in $<span class=\"token constant\">ABNORMAL_IP</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">do</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> $<span class=\"token punctuation\">(</span>iptables <span class=\"token operator\">-</span>vnL <span class=\"token operator\">|</span>grep <span class=\"token operator\">-</span>c <span class=\"token string\">\"$IP\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span>eq <span class=\"token number\">0</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> then\n        iptables <span class=\"token operator\">-</span><span class=\"token class-name\">A</span> <span class=\"token constant\">INPUT</span> <span class=\"token operator\">-</span>s $<span class=\"token constant\">IP</span> <span class=\"token operator\">-</span>j <span class=\"token constant\">DROP</span>\n        echo <span class=\"token string\">\"$(date +\"</span><span class=\"token operator\">%</span><span class=\"token class-name\">F</span> <span class=\"token operator\">%</span><span class=\"token class-name\">T</span><span class=\"token string\">\") - iptables -A INPUT -s $IP -j DROP\"</span> <span class=\"token operator\">>></span><span class=\"token operator\">~</span><span class=\"token operator\">/</span>ssh<span class=\"token operator\">-</span>login<span class=\"token operator\">-</span>limit<span class=\"token punctuation\">.</span>log\n    fi\ndone<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>",
            "tags": [
                "iptables"
            ]
        }
    ]
}